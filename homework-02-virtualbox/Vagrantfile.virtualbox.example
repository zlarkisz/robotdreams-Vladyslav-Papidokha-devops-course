# ============================================================================
# VAGRANTFILE — ДЕТАЛЬНИЙ РОЗБІР КОЖНОЇ КОМАНДИ
# ============================================================================
# Vagrant — це інструмент для автоматизації створення віртуальних машин.
# Замість того, щоб вручну клікати в VirtualBox, ти описуєш VM в коді.
# Це називається "Infrastructure as Code" (IaC).
# ============================================================================

# Vagrant.configure("2") — вказує версію конфігурації Vagrant
# "2" — це формат конфігурації (не версія Vagrant!)
# Версія 2 використовується з Vagrant 1.1+ (тобто практично завжди)
Vagrant.configure("2") do |config|

  # =========================================================================
  # VM1 — ПУБЛІЧНИЙ ВЕБСЕРВЕР З ДИНАМІЧНИМ IP
  # =========================================================================

  # config.vm.define "web" — створює VM з іменем "web"
  # Це ім'я використовується для команд: vagrant up web, vagrant ssh web
  # |web| — це змінна, через яку налаштовуємо цю конкретну VM
  config.vm.define "web" do |web|

    # -----------------------------------------------------------------------
    # BOX — базовий образ операційної системи
    # -----------------------------------------------------------------------
    # Box — це готовий образ VM (як ISO, але вже встановлена система)
    # "gutehall/ubuntu24-04" — Ubuntu 24.04 для ARM процесорів (M1/M2 Mac)
    # Vagrant завантажить цей box автоматично з Vagrant Cloud
    # Інші популярні boxes: "ubuntu/jammy64", "debian/bookworm64"
    web.vm.box = "gutehall/ubuntu24-04"

    # -----------------------------------------------------------------------
    # HOSTNAME — ім'я хоста всередині VM
    # -----------------------------------------------------------------------
    # Це ім'я буде видно в терміналі: user@web-server:~$
    # Також використовується для DNS всередині приватної мережі
    web.vm.hostname = "web-server"

    # -----------------------------------------------------------------------
    # NETWORK — мережеві налаштування
    # -----------------------------------------------------------------------
    # "public_network" — Bridged Adapter (як ми налаштовували в VirtualBox)
    # VM отримає IP від твого роутера (DHCP), як окремий пристрій в мережі
    # Без параметрів — Vagrant запитає який мережевий інтерфейс використати
    web.vm.network "public_network"

    # -----------------------------------------------------------------------
    # SYNCED_FOLDER — спільна папка між хостом і VM
    # -----------------------------------------------------------------------
    # Перший параметр: "./shared" — папка на твоєму Mac (відносний шлях)
    # Другий параметр: "/vagrant_shared" — шлях всередині VM
    # create: true — створити папку автоматично, якщо не існує
    #
    # Це дуже зручно для:
    # - Передачі файлів між Mac і VM
    # - Редагування коду в VS Code на Mac, запуску в VM
    web.vm.synced_folder "./shared", "/vagrant_shared", create: true

    # -----------------------------------------------------------------------
    # PROVIDER — налаштування для VirtualBox
    # -----------------------------------------------------------------------
    # Vagrant підтримує різні провайдери: VirtualBox, VMware, Docker, AWS
    # Тут ми налаштовуємо специфічні параметри для VirtualBox
    web.vm.provider "virtualbox" do |vb|

      # vb.memory — оперативна пам'ять в мегабайтах
      # "1024" = 1 GB RAM
      vb.memory = "1024"

      # vb.cpus — кількість процесорних ядер
      vb.cpus = 1

      # Інші корисні опції (не використовуємо, але знай про них):
      # vb.name = "my-vm-name"  — ім'я VM в інтерфейсі VirtualBox
      # vb.gui = true           — показати вікно VM (за замовчуванням headless)
      # vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
    end

    # -----------------------------------------------------------------------
    # PROVISION — автоматичне налаштування VM після створення
    # -----------------------------------------------------------------------
    # Provisioning — це виконання скриптів/команд при першому запуску VM
    #
    # "shell" — тип провізіонера (є також: ansible, puppet, chef, docker)
    # inline: — команди написані прямо тут (не в окремому файлі)
    # <<-SHELL ... SHELL — heredoc синтаксис Ruby для багаторядкового тексту
    web.vm.provision "shell", inline: <<-SHELL
      # Оновлення списку пакетів
      apt-get update
      # Встановлення nginx (вебсервер)
      # -y — автоматично відповідати "yes" на всі питання
      apt-get install -y nginx
    SHELL

    # Альтернативний спосіб — виконати команду від звичайного користувача:
    # web.vm.provision "shell", inline: "echo Hello", privileged: false
  end

  # =========================================================================
  # VM2 — ПРИВАТНИЙ СЕРВЕР ЗІ СТАТИЧНИМ IP
  # =========================================================================

  config.vm.define "private" do |priv|

    priv.vm.box = "gutehall/ubuntu24-04"
    priv.vm.hostname = "private-server"

    # -----------------------------------------------------------------------
    # PRIVATE NETWORK — ізольована мережа
    # -----------------------------------------------------------------------
    # "private_network" — Host-only мережа
    # VM доступна тільки з твого Mac і інших VM, НЕ з інтернету
    #
    # ip: "192.168.56.10" — статична IP-адреса
    # 192.168.56.x — стандартна підмережа VirtualBox для host-only
    #
    # Коли використовувати:
    # - База даних, яка не повинна бути в інтернеті
    # - Внутрішні API сервіси
    # - Тестове середовище
    priv.vm.network "private_network", ip: "192.168.56.10"

    priv.vm.synced_folder "./shared", "/vagrant_shared", create: true

    priv.vm.provider "virtualbox" do |vb|
      vb.memory = "1024"
      vb.cpus = 1
    end

    # -----------------------------------------------------------------------
    # PROVISION з зовнішнього скрипта
    # -----------------------------------------------------------------------
    # path: "provision.sh" — шлях до скрипта на хості (твоєму Mac)
    # Vagrant скопіює цей файл в VM і виконає
    #
    # Переваги зовнішнього скрипта:
    # - Легше редагувати
    # - Можна використовувати повторно
    # - Можна тестувати окремо
    # - Чистіший Vagrantfile
    priv.vm.provision "shell", path: "provision.sh"
  end

  # =========================================================================
  # VM3 — ПУБЛІЧНИЙ СЕРВЕР ЗІ СТАТИЧНИМ IP
  # =========================================================================

  config.vm.define "static" do |stat|

    stat.vm.box = "gutehall/ubuntu24-04"
    stat.vm.hostname = "static-server"

    # -----------------------------------------------------------------------
    # PUBLIC NETWORK з вказаним інтерфейсом
    # -----------------------------------------------------------------------
    # bridge: "en0: Wi-Fi" — вказуємо конкретний мережевий інтерфейс
    # Без цього параметра Vagrant запитає інтерактивно
    #
    # Як дізнатись назву інтерфейсу:
    # На Mac: networksetup -listallhardwareports
    # Або: VBoxManage list bridgedifs
    #
    # Типові назви:
    # - "en0: Wi-Fi" — Wi-Fi на Mac
    # - "en0: Ethernet" — кабельне підключення
    stat.vm.network "public_network", bridge: "en0: Wi-Fi"

    # Окрема спільна папка для цієї VM
    stat.vm.synced_folder "./static_shared", "/vagrant_static", create: true

    stat.vm.provider "virtualbox" do |vb|
      vb.memory = "1024"
      vb.cpus = 1
    end

    # Ця VM без провізіонінгу — просто чиста система
  end

end

# ============================================================================
# КОРИСНІ КОМАНДИ VAGRANT
# ============================================================================
#
# vagrant up              — запустити всі VM
# vagrant up web          — запустити тільки VM "web"
# vagrant halt            — вимкнути всі VM
# vagrant halt private    — вимкнути тільки "private"
# vagrant destroy         — видалити всі VM
# vagrant destroy -f      — видалити без підтвердження
# vagrant ssh web         — підключитися до VM "web" по SSH
# vagrant status          — показати стан всіх VM
# vagrant provision       — виконати провізіонінг повторно
# vagrant reload          — перезавантажити VM (vagrant halt + vagrant up)
# vagrant suspend         — призупинити VM (зберегти стан в RAM)
# vagrant resume          — відновити призупинену VM
#
# ============================================================================
# ПОРІВНЯННЯ ТИПІВ МЕРЕЖ
# ============================================================================
#
# ┌─────────────────┬──────────────────┬─────────────────┬─────────────────┐
# │ Тип             │ Доступ з Mac     │ Доступ з LAN    │ Доступ з Internet│
# ├─────────────────┼──────────────────┼─────────────────┼─────────────────┤
# │ NAT             │ Тільки port      │ ❌              │ ❌              │
# │ (за замовч.)    │ forwarding       │                 │                 │
# ├─────────────────┼──────────────────┼─────────────────┼─────────────────┤
# │ private_network │ ✅               │ ❌              │ ❌              │
# │ (host-only)     │                  │                 │                 │
# ├─────────────────┼──────────────────┼─────────────────┼─────────────────┤
# │ public_network  │ ✅               │ ✅              │ Залежить від    │
# │ (bridged)       │                  │                 │ роутера         │
# └─────────────────┴──────────────────┴─────────────────┴─────────────────┘
#
# ============================================================================